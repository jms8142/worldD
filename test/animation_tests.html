<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>World Denomination</title>
<link rel="stylesheet" href="/css/styles.css" type="text/css"/>
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
<script type='text/javascript' src='/js/lib/prototype.js'></script>
<script type='text/javascript' src='/js/DrawableElement.js'></script>
<script type='text/javascript' src='/js/GameTile.js'></script>

<script>

var x = 0;

var tileMap =  new Array();
var _canvas = null;
var _canvasContext = null;
var _canvasBufferContext = null;
var _gameTile = null;
var mask = {};
var _timer;
var testSettings = {
	blockHeight : 100,
	blockWidth : 100,
	maskFill : 'rgb(255,255,255)',
	maskStrokeWidth : 1,
	animationSpeed : 10,
	moveIncrement : 4
}
var MoveDirection = { UP : 0, DOWN : 1, LEFT : 2, RIGHT : 4};

var grabX = 0;
var grabY = 0;
var grabWidth =  0;
var grabHeight = 0;
var testplacementX = 0;
var testplacementY = 0;
var imgd = null;
var NewSectionSlice = 2;
var NewCaptureArea = {};

jQuery(function(){

	_canvas = document.getElementById('canvas');
	_canvasContext = _canvas.getContext('2d');
	_canvasBuffer = document.createElement('canvas');
	_canvasBuffer.width = _canvas.width;
	_canvasBuffer.height = _canvas.height;
	_canvasBufferContext = _canvasBuffer.getContext('2d');

	createTile();
	
	jQuery('#btn_moveup').click(function(e){ preLoop(MoveDirection.UP); });
	jQuery('#btn_movedown').click(function(e){ preLoop(MoveDirection.DOWN); });
	jQuery('#btn_moveleft').click(function(e){ preLoop(MoveDirection.LEFT); });
	jQuery('#btn_moveright').click(function(e){ preLoop(MoveDirection.RIGHT); });


});

function createTile(){
	//create tile
	_gameTile = new GameTile({ x : 50, y : 50, mapX : 0, mapY : 0 });
	_gameTile.setHeight(testSettings.blockHeight);
	_gameTile.setWidth(testSettings.blockWidth);
	_gameTile.setValue(1);
	_gameTile.setText(5);

	_gameTile.render(_canvasBufferContext);
	_canvasContext.drawImage(_canvasBuffer, 0, 0);

	if(imgd === null) { //initialize everything
		grabX = _gameTile.getCanvasLocation().x-1;
		grabY = _gameTile.getCanvasLocation().y-1;
		grabWidth =  _gameTile.getWidth()+2;
		grabHeight = _gameTile.getHeight()+2;
		testplacementX = _gameTile.getCanvasLocation().x + (_gameTile.getWidth()+10);
		testplacementY = _gameTile.getCanvasLocation().y-1;

		imgd = _canvasBufferContext.getImageData(grabX, grabY, grabWidth, grabHeight);
	}
}

function preLoop(direction){
	//some static settings that don't need to be assigned in the loop
	if(direction === this.MoveDirection.UP || direction === this.MoveDirection.DOWN){
		NewCaptureArea.xPlacement = _gameTile.getCanvasLocation().x - 1;
		NewCaptureArea.width = imgd.width;
		NewCaptureArea.x = 0;		
	} else { //right or left
		NewCaptureArea.yPlacement = _gameTile.getCanvasLocation().y - 1;
		NewCaptureArea.height = imgd.height;
		NewCaptureArea.y = 0;	
	}

	_timer = setInterval("loop(" + direction + ")",testSettings.animationSpeed);
}


function loop(direction){
	
	NewSectionSlice += testSettings.moveIncrement;
	//console.info(direction);
	switch (direction){
		case this.MoveDirection.UP :	
			NewCaptureArea.yPlacement = _gameTile.getCanvasLocation().y  - NewSectionSlice;			
			NewCaptureArea.height = imgd.height - NewSectionSlice;
			NewCaptureArea.y = NewSectionSlice;
			break;
		case this.MoveDirection.DOWN :
			NewCaptureArea.yPlacement = _gameTile.getCanvasLocation().y + NewSectionSlice;
			NewCaptureArea.height = imgd.height - NewSectionSlice;
			NewCaptureArea.y = 0;		
			break;
		case this.MoveDirection.LEFT :		
			NewCaptureArea.xPlacement = _gameTile.getCanvasLocation().x - NewSectionSlice;
			NewCaptureArea.width = imgd.width - NewSectionSlice;
			NewCaptureArea.x = NewSectionSlice;
			break;
		case this.MoveDirection.RIGHT :		
			NewCaptureArea.xPlacement = _gameTile.getCanvasLocation().x + NewSectionSlice;
			NewCaptureArea.width = imgd.width - NewSectionSlice;
			NewCaptureArea.x = 0;	
			break;
	}

	
	

	_draw();

	//console.info(NewSectionSlice);
	
	if(NewSectionSlice > imgd.height) {
		window.clearInterval(_timer);
		clearArea();
	}
}

function _draw(){
	//mask the area first
	clearArea();
	
	//write some error catching here
	try {
		_canvasBufferContext.putImageData(imgd,
										NewCaptureArea.xPlacement,
										NewCaptureArea.yPlacement,
										NewCaptureArea.x,
										NewCaptureArea.y,
										NewCaptureArea.width,
										NewCaptureArea.height
										);
		
		_canvasContext.drawImage(_canvasBuffer,0,0);
	} 
	catch(err){
		console.info(err.message);
		console.info(NewCaptureArea);
		window.clearInterval(_timer);
	}
}

function clearArea(){
	_canvasBufferContext.fillStyle = testSettings.maskFill;
	_canvasBufferContext.fillRect(grabX,grabY,grabWidth+1,grabHeight+1);
}


</script>

</head>

<body>
Animation Tests<br/>
<canvas id="canvas" width="300" height="300">
Canvas not supported.
</canvas><br/><br/>
<br/>
<input type="button" value="Move Up" id="btn_moveup"/>
<input type="button" value="Move Down" id="btn_movedown"/>
<input type="button" value="Move Left" id="btn_moveleft"/>
<input type="button" value="Move Right" id="btn_moveright"/>

</body>
</html>
